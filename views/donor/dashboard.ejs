<div class="flex items-center justify-between mb-4">
  <h2 class="text-2xl font-semibold">Donor Dashboard</h2>
  <form class="flex gap-2" method="get" action="/donor/dashboard">
    <input class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="search" name="q" placeholder="Search requests" value="<%= q %>" />
    <button class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow" aria-label="Search">Search</button>
  </form>
  </div>
<div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
  <% if (!requests.length) { %>
    <div class="md:col-span-2 xl:col-span-3 px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">No open requests.</div>
  <% } %>
  <% requests.forEach(r => { %>
    <div class="p-4 rounded-xl bg-white/80 dark:bg-slate-900/60 backdrop-blur border border-slate-200/60 dark:border-slate-700/60 shadow animate-fade-in" data-request-id="<%= r._id %>" data-amount-requested="<%= r.amountRequested %>">
      <div class="flex items-center justify-between">
        <h5 class="text-base font-semibold"><%= r.title %></h5>
        <span class="text-xs px-2 py-1 rounded bg-slate-200 dark:bg-slate-700 status-text"><%= r.status %></span>
      </div>
      <p class="text-sm text-slate-600 dark:text-slate-300 mt-1"><%= r.description %></p>
      <div class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded mt-2 overflow-hidden">
        <div class="progress-bar h-full bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 transition-all duration-700" data-progress="<%= Math.min(100, Math.round((r.amountFunded / r.amountRequested) * 100)) %>"></div>
      </div>
      <div class="text-xs mt-1">₹ <%= r.amountFunded %> / ₹ <%= r.amountRequested %> — by <%= r.student.name %></div>
      <% if (r.status === 'open') { %>
      <form class="donate-form mt-3 flex gap-2" data-id="<%= r._id %>">
        <input required type="number" min="1" name="amount" class="w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Amount" />
        <button class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow" type="submit">Donate</button>
      </form>
      <% } %>
    </div>
  <% }) %>
</div>
<script>
  // Initialize progress widths
  document.querySelectorAll('[data-progress]').forEach(el => {
    const pct = Number(el.getAttribute('data-progress')) || 0;
    el.style.width = pct + '%';
  });
  // Donate form submit handler
  document.querySelectorAll('.donate-form').forEach(f => {
    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector('button[type="submit"]');
      const amount = form.amount.value;
      const requestId = form.getAttribute('data-id');
      btn.disabled = true; btn.classList.add('opacity-60');
      try {
        const res = await fetch('/donor/donate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ requestId, amount })
        });
        if (res.ok) { form.reset(); }
        else { alert('Donation failed'); }
      } catch(e) {
        alert('Network error');
      } finally {
        btn.disabled = false; btn.classList.remove('opacity-60');
      }
    });
  });
</script>
